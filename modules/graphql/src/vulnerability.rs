use async_graphql::{Context, FieldError, FieldResult, Object};
use std::sync::Arc;
use trustify_common::db::Database;
use trustify_entity::vulnerability::Model as Vulnerability;
use trustify_module_ingestor::graph::Graph;

#[derive(Default)]
pub struct VulnerabilityQuery;

#[Object]
impl VulnerabilityQuery {
    async fn get_vulnerability_by_id(
        &self,
        ctx: &Context<'_>,
        identifier: String,
    ) -> FieldResult<Vulnerability> {
        let db = ctx.data::<Arc<Database>>()?;
        let graph = ctx.data::<Arc<Graph>>()?;
        let vulnerability = graph.get_vulnerability(&identifier, db.as_ref()).await;

        match vulnerability {
            Ok(Some(vulnerability)) => Ok(Vulnerability {
                id: vulnerability.vulnerability.id,
                title: vulnerability.vulnerability.title,
                reserved: vulnerability.vulnerability.reserved,
                published: vulnerability.vulnerability.published,
                modified: vulnerability.vulnerability.modified,
                withdrawn: vulnerability.vulnerability.withdrawn,
                cwes: vulnerability.vulnerability.cwes,
                base_score: vulnerability.vulnerability.base_score,
                base_severity: vulnerability.vulnerability.base_severity,
            }),
            Ok(None) => Err(FieldError::new("Vulnerability not found")),
            Err(err) => Err(FieldError::from(err)),
        }
    }

    async fn get_vulnerabilities(&self, ctx: &Context<'_>) -> FieldResult<Vec<Vulnerability>> {
        let db = ctx.data::<Arc<Database>>()?;
        let graph = ctx.data::<Arc<Graph>>()?;
        let vulnerabilities = graph
            .get_vulnerabilities(db.as_ref())
            .await
            .unwrap_or_default();

        vulnerabilities
            .into_iter()
            .map(|vulnerability| {
                Ok(Vulnerability {
                    id: vulnerability.vulnerability.id,
                    title: vulnerability.vulnerability.title,
                    reserved: vulnerability.vulnerability.reserved,
                    published: vulnerability.vulnerability.published,
                    modified: vulnerability.vulnerability.modified,
                    withdrawn: vulnerability.vulnerability.withdrawn,
                    cwes: vulnerability.vulnerability.cwes,
                    base_score: vulnerability.vulnerability.base_score,
                    base_severity: vulnerability.vulnerability.base_severity,
                })
            })
            .collect()
    }
}
