use crate::{advisory::model::AdvisoryHead, vulnerability::model::VulnerabilityHead};
use serde::{Deserialize, Serialize};
use std::{collections::BTreeMap, ops::Deref};
use utoipa::ToSchema;

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisRequest {
    pub purls: Vec<String>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisDetails {
    #[serde(flatten)]
    pub head: VulnerabilityHead,

    /// Map of status to advisories
    ///
    /// Allowed status values:
    /// - `affected`: Advisories that affect the package
    /// - `under_investigation`: Advisories that might affect the package, but the investigation is still ongoing
    ///
    /// Additional status values may be added in the future; see API documentation for details.
    pub status: BTreeMap<String, Vec<AdvisoryHead>>,
}

#[derive(Serialize, Deserialize, Debug, ToSchema)]
pub struct AnalysisResponse(pub BTreeMap<String, Vec<AnalysisDetails>>);

impl Deref for AnalysisResponse {
    type Target = BTreeMap<String, Vec<AnalysisDetails>>;

    fn deref(&self) -> &Self::Target {
        &self.0
    }
}
